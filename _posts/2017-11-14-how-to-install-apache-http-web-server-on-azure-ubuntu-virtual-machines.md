---
layout: post
published: true
title: Deploy Flask Application to Azure Virtual Machine Running Apache Web Server
categories:
  - Web Application
tags:
  - Python
  - 'Azure '
  - Cloud Service
  - Flask
  - Ubuntu
  - Apache Web Server
---

Apache HTTP Server is the most used web server software in the world and public cloud services, such as Amazon Web Services and Microsoft Azure, make setting up a Virtual Private Server(VPS) hosting web applications a lot easier than traditional way that using physical servers. Unlinke many other tutorials that focus on traditional web hosts and configurations for running PHP and/or .NET applications, this post presents steps of installing and configuring Apache HTTP Web Server on an Azure Ubuntu Virtual Machine to host Flask Web applications. <!--more-->

## Deploy Linux Virtual Machines on Azure
You can follow the steps from [Azure Linux Virtual Machines Quickstarts](https://docs.microsoft.com/en-us/azure/virtual-machines/linux/) to create a virtual machine running Ubuntu. The quickstart also provide steps of installing a NGINX webserver on the virtual machine. 

One of the steps is to create SSH key pair, if you don't have an existing one. You can run following command in a Bash shell. If you are using Windows, you can use Git Bash or Bash on Ubuntu on Windows 10. Follow the on-screen directions to privide file path and name for the public key file. 
```
ssh-keygen -t rsa -b 2048
```

## Settings for Connection to Virtual Machine
After deloyment of virtual machine, there are two things you need to set in order to connect to the virtual machine.
* Reset password through the **Reset password** tab on the left-hand menu
* Open port 80 for web traffic. Click **Networking** tab on the left-hand menu, and then **Add inbound port rule**, select type **http** from the **Service** dropbox.

You can run `ssh username@xx.xxx.xxx.xxx` in your bash shell to connect to your virtual machine. The `username` is the username you picked during set up virtual machine. `xx.xxx.xxx.xxx` is the public IP address, which you can get from the **Overview** page of your deployed virtual machine.

If you are using Windows, you might want to use WinSCP and/or PuTTYY to connect to the virtual machine. Refer to [https://winscp.net/eng/download.php](https://winscp.net/eng/download.php) for downloading and setting WinSCP and PuTTY. You might need to set the proxy in the WinSCP, if you behind a proxy server. Note: there is no http:// in the proxy host name.

## Install Apache HTTP Web Server

To install the Apache web server you need to run the following:
```
sudo apt-get update
sudo apt-get install apache2
```
The `apache2` in the command is the web server. It will listen for web requests (which are generated by our users visiting our web application using their browsers) and hand these requests over to our web application. 

Once the Apache server installed successfully, you can enter the public IP adress of your virtual machine in your browser's address bar, and you should see a page saying "**Apache2 Ubuntu Default Page: It Works!**" or something similar. Congratulations, you successfully set up a VPS running Apache HTTP Web Server. 

The remaining part of this post focuses on settings for Flask applications deployment.  

## Install mod_wsgi

As our application is [Flask](http://flask.pocoo.org/), we also need to install **[mod_wsgi](http://modwsgi.readthedocs.io/en/develop/index.html)**, which is a common interface between web servers and Flask applications, which allows Apache to talk to application and vice versa.
```
sudo apt-get update
sudo apt-get install libapache2-mod-wsgi   # for python 2.7
sudo apt-get install libapache2-mod-wsgi-py3  #for python 3
```
 
## Install Python Environment and Flask

Final step is to set up Python environment and dependent libraries for our Flask application. After login to the virtual machine, you can check your python version and pip version through running following commands. You might have both python2.7 and python 3.x are pre-installed. 

```
python --version   # for python 2.7
python3 --version  # for python 3.x
pip --version    
pip3 --version
```

If `pip` is not currently installed yet, you can run following commands to install pip.
```
sudo apt-get update
sudo apt-get install python-pip  #for python 2.7
sudo apt-get install python3-pip #for python 3.x
```
### Python package management with pip

To install a package with pip, simply run:
```
pip install <package-name> # for python 2.7
pip3 install <package-name> # for python 3.x
```
To install Flask, simply run this:
```
pip install flask # for python 2.7
pip3 install flask # for python 3.x
```
After installing a set of packages, it is common courtesy in the Python community to create a list of packages that are required to run the program, so others can quickly install every thing required. This also has the added benefit that any new member of your project will be able to run your code quickly.

This list can be created with pip by running this:
```
pip freeze > requirements.txt
```
To install all packages from this file, you can run:
```
pip install -r requirements.txt
```
### Sandbox dependency with virtualenv
[Virtualenv](https://virtualenv.pypa.io/en/stable/) is a tool to create isolated Python environments. The secret to virtualenv is tricking your computer into looking for and installing packages in the project directory rather than in the main Python directory, which allows you to keep them completely separate.

You can install `virtualenv` for python 2.7 thorugh
```
sudo pip install virtualenv
```
For python 3, since `virtualenv` are bundled with python > 3.4. So you can run 
```
python3 -m venv <DIR>
```
to create a virtual environment for python 3.  Sometimes the `venv` is not pre-installed, then you might need to install the `python3-venv` package using following command.
```
sudo apt-get install python3-venv
```
To create the environment for your project, simply run: 
```
# cd to the project folder
virtualenv env # for python 2.7
python3 -m venv env # for python 3.x
```
The command tells `virtualenv` or `venv` to store all dependent packages into the `env` folder. Then you can use following commands to activate and deactivate the built virutal environment.
 ```
source  env/bin/activate
# you can use `pip` (no matter python 2 or 3) to install packages for the activaged environment
deactivate
```


## Deploy Flask Application

* Copy the project folder to `/var/www`. If get get a `permission denied` error, then you need to tak ownership of the `/var/www` directory for the Linux user that you're using, through running:
```
sudo chown -R <USERNAME> /var/www
```
* Copy the `.conf` file to `/etc/apache2/sites-available`
* Run following commands to start serve new Flask application;
```
sudo a2dissite 000-default.conf
sudo a2ensite hello.conf
sudo service apache2 reload
```
* If get error run following command to find what went wrong:
```
sudo tail â€“f /var/log/apache2/error.log
```



## References

* [Azure Linux Virtual Machines Quickstarts](https://docs.microsoft.com/en-us/azure/virtual-machines/linux/)
